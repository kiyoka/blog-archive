*Nendo**Ruby* コードブロックに副作用が混在するかを検出できるかどうか

先日のScalaの本からの流れで勝手に盛り上ってしまっている話題を前へ進めてみる。

さて、*[Nendo*]にimmutableなコードブロックを保証するスペシャルフォームを追加したいと考えている。
こんな感じ。もしコード中に破壊的操作を行うメソッドが混在していたら、例外を発生させる。
!(immutable S式)

immutableは*[Nendo*]の予約語で、引数に取ったS式はマクロ展開されたあと破壊的操作が無いかを検査される。
ランタイムではなくて、コンパイルフェーズでチェックができればベスト。
これができたら画期的だと思う。
やりたい理由は、テスタビリティの確保だ。破壊的操作が無いコードはテストコードが非常に書きやすい。

破壊的操作があるプログラムは、環境を用意するのも一苦労だ。
以下の引用は、テスト環境を用意するのが大変という話を説明するのにもってこいのやつ。
 ##(amazon 4274068471)  Coders at Work プログラミングの技をめぐる探求
  Joe Armstrong
   「再利用性の欠如はオブジェクト指向言語から来るもので、関数型言語では
   話が違います。オブジェクト指向言語の問題は、それが周りに引きずってい
   る暗黙の環境にあります。バナナが欲しかったのに、手に入れてみたら、バ
   ナナを握ったゴリラと、それにジャングルまでついてきたというようなもの
   なのです。」
つまり、オブジェクト指向の方法ではテストデータや環境を準備するための依存を断ち切るのが非常に困難だということだ。

話を戻して、破壊的操作のある/なしを切り分けることが本当にできるのか？というのは、今はできると思っておいたほうが楽しいので、しばらくはつっこまないで頂きたい(笑;)
難しいと思っている理由は、いろいろあるんだけど、*[Nendo*]はRubyへのトランスレータとして実装しているので、ターゲットが生粋のオブジェクト指向言語だというところ。

オブジェクト指向は、基本的にはオブジェクトに状態を持つパラダイムであり、オブジェクトの状態を変更しながらプログラムが走行させるのが基本だ。
つまり、状態の破壊的操作が基本にあるということ。
かたや、私がやりたいのはあるコードブロック内では非破壊的なメソッドだけを集めてプログラミングしたいという要求であり、Rubyを選んだ時点で矛盾があるような気もするが…
(ただ、似たような状況に立っている言語のScalaがうまくやっているということわかったので少し楽観的だ)

図で説明してみる。
 ##(img https://cacoo.com/diagrams/8ju3sHEwIE6iWrI5-B7327.png)

 ##(img https://cacoo.com/diagrams/8ju3sHEwIE6iWrI5-2299F.png)

 ##(img https://cacoo.com/diagrams/8ju3sHEwIE6iWrI5-AFB4E.png)

いくら書いても、具体的にどうやればできるという話が出てこないけれども、それはこれから考えるのだよ(笑)。
最後の手段としては、人間が慎重に破壊的操作の無いメソッドを選び出してリストを作るということになるのだけど…
ブラックリストではなく、ホワイトリストになるのかな。
因みに、ScalaではSet/Mapはひとつの親クラスからimmutable版とmutable版のそれぞれをtraitで継承して作りだしている。Listはimmutable版しかなくArrayはmutable版しかない。あとはプログラマが慎重に部品を選びなさいというような感じだと思う。(本を読んだだけのレベルだけど)

*[Nendo*]はどうするか。これからじっくり考えます。

##(comment-data shiro %e3%82%b3%e3%83%b3%e3%83%91%e3%82%a4%e3%83%ab%e6%99%82%e3%81%ab%e3%82%84%e3%82%8b%e3%81%ab%e3%81%af%e3%80%81%e5%9e%8b%e6%83%85%e5%a0%b1%e3%81%8c%e3%81%82%e3%81%a3%e3%81%9f%e6%96%b9%e3%81%8c%e5%9c%a7%e5%80%92%e7%9a%84%e3%81%ab%e6%a5%bd%e3%81%a7%e3%81%99%e3%81%ad%e3%80%82%e7%94%9f%e3%81%aeScheme%e3%81%ae%e5%a0%b4%e5%90%88%e3%80%81%e3%81%9d%e3%81%93%e3%81%8b%e3%82%89%e5%8f%82%e7%85%a7%e3%81%97%e3%81%a6%e3%81%84%e3%82%8b%e6%89%8b%e7%b6%9a%e3%81%8d%e3%82%92%e5%85%a8%e9%83%a8%e8%bf%bd%e3%81%a3%e3%81%8b%e3%81%91%e3%81%a6%e3%81%84%e3%81%8b%e3%81%ad%e3%81%b0%e3%81%aa%e3%82%89%e3%81%9a%e3%80%81%e7%b5%90%e5%b1%80%e3%81%9d%e3%82%8c%e3%81%af%e3%81%9d%e3%81%ae%e5%a0%b4%e3%81%a7%e4%b8%80%e7%a8%ae%e3%81%ae%e5%9e%8b%e6%83%85%e5%a0%b1%e3%82%92%e3%81%a4%e3%81%91%e3%82%88%e3%81%86%e3%81%a8%e3%81%99%e3%82%8b%e3%81%ae%e3%81%a8%e5%90%8c%e3%81%98%e3%81%a7%e3%81%99%e3%81%8b%e3%82%89%e3%80%82%e5%8f%82%e7%85%a7%e9%80%8f%e6%98%8e%e3%81%8b%e3%81%a9%e3%81%86%e3%81%8b%e3%81%a3%e3%81%a6%e6%83%85%e5%a0%b1%e3%81%a0%e3%81%91%e8%bf%bd%e3%81%88%e3%81%b0%e8%89%af%e3%81%84%e3%81%ae%e3%81%a7%e5%ae%8c%e5%85%a8%e3%81%aa%e5%9e%8b%e4%bb%98%e3%81%91%e3%81%bb%e3%81%a9%e5%a4%a7%e5%a4%89%e3%81%98%e3%82%83%e3%81%aa%e3%81%84%e3%81%a7%e3%81%99%e3%81%8c%e3%80%81%e5%a4%96%e3%81%8b%e3%82%89%e5%bc%95%e6%95%b0%e3%81%a7%e6%b8%a1%e3%81%95%e3%82%8c%e3%82%8b%e9%96%a2%e6%95%b0%e3%81%aa%e3%81%a9%e3%82%82%e8%bf%bd%e3%81%a3%e3%81%8b%e3%81%91%e3%82%8b%e3%81%93%e3%81%a8%e3%81%ab%e3%81%aa%e3%82%8b%e3%81%ae%e3%81%a7%e3%80%81%e3%82%b0%e3%83%ad%e3%83%bc%e3%83%90%e3%83%ab%e3%81%aa%e3%83%97%e3%83%ad%e3%82%b0%e3%83%a9%e3%83%a0%e3%81%ae%e8%a7%a3%e6%9e%90%e3%81%ab%e3%81%aa%e3%82%8a%e3%81%9d%e3%81%86%e3%81%a7%e3%81%99%20%28%e5%a4%96%e3%81%8b%e3%82%89%e6%b8%a1%e3%81%95%e3%82%8c%e3%82%8b%e9%96%a2%e6%95%b0%e5%bc%95%e6%95%b0%e3%81%ab%e5%9e%8b%e6%83%85%e5%a0%b1%e3%82%92%e3%82%a2%e3%83%8e%e3%83%86%e3%83%bc%e3%83%88%e3%81%a7%e3%81%8d%e3%82%8b%e3%82%88%e3%81%86%e3%81%ab%e3%81%97%e3%81%a6%e3%81%84%e3%82%8c%e3%81%b0%e5%88%a5%e3%81%a7%e3%81%99%e3%81%8c%29%e3%80%82%0d%0a%0d%0a%e3%81%82%e3%81%a8%e3%80%81immutable%e3%81%af%e3%80%8c%e5%af%be%e8%b1%a1%e3%81%8c%e5%a4%89%e6%9b%b4%e4%b8%8d%e5%8f%af%e3%80%8d%e3%81%a8%e3%81%84%e3%81%86%e5%bd%a2%e5%ae%b9%e8%a9%9e%e3%81%a0%e3%81%a8%e6%80%9d%e3%81%86%e3%81%ae%e3%81%a7%e3%80%81%e5%a4%89%e6%95%b0%e3%82%84%e3%82%aa%e3%83%96%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%ab%e5%af%be%e3%81%97%e3%81%a6%e4%bd%bf%e3%81%86%e5%bd%a2%e5%ae%b9%e8%a9%9e%e3%81%a7%e3%81%82%e3%81%a3%e3%81%a6%e3%80%81%e3%80%8c%e5%bc%8f%e3%80%8d%e3%81%ab%e5%af%be%e3%81%97%e3%81%a6%e4%bd%bf%e3%81%86%e3%81%ae%e3%81%af%e9%81%95%e5%92%8c%e6%84%9f%e3%81%8c%e3%81%82%e3%82%8a%e3%81%be%e3%81%99%e3%80%82%e5%bc%8f%e3%81%ab%e5%af%be%e3%81%97%e3%81%a6%e5%bd%a2%e5%ae%b9%e3%81%99%e3%82%8b%e3%81%aa%e3%82%89referentially%20transparent%e3%81%8c%e6%ad%a3%e7%a2%ba%e3%81%a0%e3%81%a8%e6%80%9d%e3%81%84%e3%81%be%e3%81%99%e3%81%8c%e3%80%81%e9%95%b7%e3%81%84%e3%81%ae%e3%81%a7%20%28pure%20%3c%e5%bc%8f%3e%29%20%e3%81%a8%e3%81%8b%e3%81%8b%e3%81%aa%3f%20%28no-side-effect%20%3c%e5%bc%8f%3e%29%20%e3%81%af%e3%81%a1%e3%82%87%e3%81%a3%e3%81%a8%e3%81%a0%e3%81%95%e3%81%84%e3%81%97%e3%80%82)
##(comment-data kiyoka %e3%82%b3%e3%83%a1%e3%83%b3%e3%83%88%e3%81%82%e3%82%8a%e3%81%8c%e3%81%a8%e3%81%86%e3%81%94%e3%81%96%e3%81%84%e3%81%be%e3%81%99%e3%80%82%0d%0a%0d%0ashiro%e3%81%95%e3%82%93%e3%81%ae%e3%82%b3%e3%83%a1%e3%83%b3%e3%83%88%e3%82%92%e8%aa%ad%e3%82%80%e3%81%be%e3%81%a7%e3%80%81%e5%a4%96%e3%81%8b%e3%82%89%e6%b8%a1%e3%81%95%e3%82%8c%e3%82%8b%e9%96%a2%e6%95%b0%e3%81%ab%e6%80%9d%e3%81%84%e8%87%b3%e3%81%a3%e3%81%a6%e3%81%84%e3%81%be%e3%81%9b%e3%82%93%e3%81%a7%e3%81%97%e3%81%9f%e3%80%82%e3%81%9d%e3%81%86%e3%81%8b%e3%80%81%e3%81%9d%e3%82%8c%e3%82%82%e3%81%82%e3%82%8a%e3%81%be%e3%81%99%e3%81%ad%e3%80%82%0d%0a%e5%8f%82%e7%85%a7%e9%80%8f%e6%98%8e%e3%81%8b%e3%81%a9%e3%81%86%e3%81%8b%e3%82%92%e3%82%b0%e3%83%ad%e3%83%bc%e3%83%90%e3%83%ab%e3%81%ab%e8%a7%a3%e6%9e%90%e3%81%97%e3%81%aa%e3%81%84%e3%81%a8%e3%81%84%e3%81%91%e3%81%aa%e3%81%84%e3%81%ae%e3%81%af%e5%a4%a7%e5%a4%89%e3%81%a7%e3%81%99%e3%81%ad%e3%80%82Ruby%e3%81%ae%e3%83%a9%e3%82%a4%e3%83%96%e3%83%a9%e3%83%aa%e3%82%af%e3%83%a9%e3%82%b9%e3%81%ae%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%81%8c%e5%8f%82%e7%85%a7%e9%80%8f%e6%98%8e%e3%81%8b%e3%81%a9%e3%81%86%e3%81%8b%e3%82%92%e8%87%aa%e5%8b%95%e3%81%a7%e6%a4%9c%e6%9f%bb%e3%81%99%e3%82%8b%e3%81%ae%e3%82%82%e9%9b%a3%e3%81%97%e3%81%84%e3%81%a8%e3%81%84%e3%81%86%e5%95%8f%e9%a1%8c%e3%82%82%e3%81%82%e3%82%8a%e3%81%be%e3%81%99%e3%80%82%0d%0a%e3%82%84%e3%81%af%e3%82%8a%e5%8f%82%e7%85%a7%e9%80%8f%e6%98%8e%e3%81%aa%e9%96%a2%e6%95%b0%e3%82%84%e5%a4%89%e6%95%b0%28%e3%81%a8%e3%81%84%e3%81%86%e3%81%8b%e5%ae%9a%e6%95%b0%29%e3%82%92%e3%83%aa%e3%82%b9%e3%83%88%e3%82%a2%e3%83%83%e3%83%97%e3%81%99%e3%82%8b%e3%83%9b%e3%83%af%e3%82%a4%e3%83%88%e3%83%aa%e3%82%b9%e3%83%88%e6%96%b9%e5%bc%8f%e3%81%8c%e6%9c%89%e5%8a%9b%e3%81%aa%e3%81%ae%e3%81%8b%e3%82%82%e3%81%97%e3%82%8c%e3%81%be%e3%81%9b%e3%82%93%e3%80%82%0d%0a%e3%81%9d%e3%82%8c%e3%81%af%e3%81%82%e3%82%8b%e6%84%8f%e5%91%b3%e3%80%81%e5%9e%8b%e6%83%85%e5%a0%b1%e3%81%ae%e3%82%a2%e3%83%8e%e3%83%86%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e6%89%8b%e4%bd%9c%e6%a5%ad%e3%81%a7%e3%82%84%e3%82%8b%e3%81%a8%e3%81%84%e3%81%86%e3%81%93%e3%81%a8%e3%81%ab%e7%9b%b8%e5%bd%93%e3%81%99%e3%82%8b%e3%81%ae%e3%81%8b%e3%81%aa%e3%80%82%0d%0a%e3%83%9b%e3%83%af%e3%82%a4%e3%83%88%e3%83%aa%e3%82%b9%e3%83%88%e3%81%aa%e3%81%ae%e3%81%a7%e3%80%81%e5%bf%85%e8%a6%81%e3%81%aa%e5%88%86%e3%81%a0%e3%81%91%e3%82%92%e3%82%a2%e3%83%8e%e3%83%86%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%99%e3%82%8c%e3%81%b0%e3%81%84%e3%81%84%e3%81%ae%e3%81%a7%e5%a7%8b%e3%82%81%e3%82%84%e3%81%99%e3%81%84%e3%81%a7%e3%81%99%e3%81%8c%e3%80%81%e9%96%a2%e6%95%b0%e3%81%8c%e5%a2%97%e3%81%88%e3%82%8b%e3%81%94%e3%81%a8%e3%81%ab%e6%89%8b%e4%bd%9c%e6%a5%ad%e3%81%a7%e8%bf%bd%e5%be%93%e3%81%97%e3%81%aa%e3%81%84%e3%81%a8%e3%81%84%e3%81%91%e3%81%aa%e3%81%84%e3%81%ae%e3%81%8c%e9%9b%a3%e7%82%b9%e3%81%a7%e3%81%99%e3%80%82%0d%0a%e6%bc%8f%e3%82%8c%e3%81%8c%e5%87%ba%e3%82%8b%e3%81%a8%e4%be%bf%e5%88%a9%e3%81%95%e3%81%8c%e5%8d%8a%e6%b8%9b%e3%81%99%e3%82%8b%e3%81%ae%e3%81%a7%e2%80%a6%0d%0a)
##(comment-data kiyoka %e3%82%82%e3%81%86%e3%81%b2%e3%81%a8%e3%81%a4%e3%80%82immutable%e3%81%af%e5%bd%a2%e5%ae%b9%e8%a9%9e%e3%81%a7%e3%81%99%e3%81%ad%e3%80%82%28pure%20%3c%e5%bc%8f%3e%29%20%e3%81%8c%e3%81%8b%e3%81%a3%e3%81%93%e3%81%84%e3%81%84%e3%81%ae%e3%81%a7%e5%ae%9f%e7%8f%be%e3%81%a7%e3%81%8d%e3%81%9f%e3%82%89%e3%81%93%e3%82%8c%e3%81%ab%e3%81%99%e3%82%8b%e3%81%8b%e3%82%82%e3%81%97%e3%82%8c%e3%81%be%e3%81%9b%e3%82%93%e3%80%82%e4%bd%86%e3%81%97%e5%ae%9f%e7%8f%be%e3%81%a7%e3%81%8d%e3%81%9f%e3%82%89%e3%81%ae%e8%a9%b1%e3%81%a7%e3%81%99%e3%81%8c%e3%80%82%20%3a%29)
