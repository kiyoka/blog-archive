*MongoDB* MongoDB試用開始
*[http://www.mongodb.org/|MongoDB*]をさわりはじめた。versionは現時点の最新の version 2.0.1 。
##(amazon-m 1449381561) 私が参照している本。
メモリがいくらあっても足りない。4GByte RAMのサーバマシンで3.8GByteまで使っている。
もちろん他にもいろいろ走っているので、2GByteほどswapしている。

まず、1GByte程度のapacheログをmongoimportできるJSON形式にしてimportした。
mongoimport用の変換内容は時刻部分をDate型に、転送サイズを数値型に変換した。それ以外は文字列のまま。
mongoimportで投入し、リクエスト時刻フィールドにIndexを張ったらDBサイズが5GByteになった。
うげー、でかいよ。

その後、リクエスト時刻部分から時分秒を00:00:00に切り落としたDate型をもうひとつ追加したら、DBサイズがまた肥大した。
DISKもよく食う。

結局次のようなドキュメントの構造になった。
Indexはtimestampとurlに張って、14GByteのDBサイズに！

! $ mongo --host black sumibi
!MongoDB shell version: 2.0.1
!connecting to: black:27017/sumibi
!> db.apachelog.findOne()
!{
!	"_id" : ObjectId("4eaf66c734168d18eb210c4e"),
!	"client_id" : "-",
!	"hostname" : "111.111.111.111",
!	"referer" : "-",
!	"req" : {
!		"method" : "GET",
!		"url" : "/sumibi/Sumibi_stable.wsdl"
!	},
!	"request" : "GET /sumibi/Sumibi_stable.wsdl HTTP/1.0",
!	"result_code" : "200",
!	"tfrsize" : 6940,
!	"timestamp" : ISODate("2011-10-08T21:56:22Z"),
!	"timestampDaily" : ISODate("2011-10-08T15:00:00Z"),
!	"user_agent" : "-",
!	"username" : "-"
!}
!> db.apachelog.count();
!6072350
 ※ hostname部分はblog用にマスクしてあります。

それにしてもMongoDBのshellがJavaScriptなのが便利だなーと思ったのも束の間、すぐにJavaScriptの非力さが気になりはじめた。
Prototypejsを使いたくなるほどのプレーンさだ。でも、mongo shellには載らないだろうな。うーん。なんとかならんかな。

久々にこんなプレーンなfor文を書いたよ。半年ぶりくらいかなー。
! for ( i = 0 ; i < a.length ; i++ ) {
! ...
!}

Prototypejsを使えば、mapやeachなんかを使って書くのでループ変数を使ったコーディングは懐しささえ感じる。
まだ使い始めたばかりなので、癖はわからないが、いろいろ負荷の高い処理をやらせたりMapReduceをやったりして数日使ってみようと思う。

※ ちなみに個人的な学習用リポジトリは*[http://github.com/kiyoka/learn-mongodb|kiyoka/learn-mongodb - GitHub*]で公開しているので、クエリのサンプルとか見れますよ。

##(comment-data kiyoka %e8%87%aa%e5%88%86%e3%81%a7%e3%82%b3%e3%83%a1%e3%83%b3%e3%83%88%e3%81%97%e3%81%be%e3%81%99%e3%80%82%0d%0a%e3%81%aa%e3%82%93%e3%81%8b%e3%83%a1%e3%83%a2%e3%83%aa%e3%81%8c%e8%b6%b3%e3%82%8a%e3%81%aa%e3%81%84%e3%81%a8%e3%81%84%e3%81%86%e7%99%ba%e6%83%b3%e3%81%8cMongoDB%e3%81%ab%e5%90%88%e3%81%a3%e3%81%a6%e3%81%84%e3%81%aa%e3%81%84%e6%b0%97%e3%81%8c%e3%81%99%e3%82%8b%e3%80%82%0d%0a%e3%83%87%e3%83%bc%e3%82%bf%e3%83%99%e3%83%bc%e3%82%b9%e3%81%ae%e3%82%b5%e3%82%a4%e3%82%ba%e3%81%ab%e5%af%be%e3%81%97%e3%81%a6%e3%83%a1%e3%83%a2%e3%83%aa%e3%81%8c%e8%b6%b3%e3%82%8a%e3%81%aa%e3%81%84%e3%81%ae%e3%81%a7%e3%81%82%e3%82%8c%e3%81%b0%e3%83%9e%e3%82%b7%e3%83%b3%e3%82%92%e5%a2%97%e3%82%84%e3%81%97%e3%81%a6%e5%88%86%e6%95%a3%e3%81%99%e3%82%8b%e3%81%ae%e3%81%8c%e7%ad%8b%e3%81%8b%e3%81%aa%e3%83%bc%e3%80%82%0d%0a%e3%82%82%e3%81%86%e3%81%a1%e3%82%87%e3%81%a3%e3%81%a8%e5%ae%9f%e9%a8%93%e3%81%8c%e9%80%b2%e3%82%93%e3%81%a0%e3%82%89%e3%80%81AWS%e3%81%ae%e6%99%82%e9%96%93%e8%b2%b8%e3%81%97%e3%82%a4%e3%83%b3%e3%82%b9%e3%82%bf%e3%83%b3%e3%82%b9%e3%82%92%e5%80%9f%e3%82%8a%e3%82%8b%e3%81%ae%e3%81%8c%e3%81%84%e3%81%84%e3%81%ae%e3%81%8b%e3%81%aa%e3%80%82)
