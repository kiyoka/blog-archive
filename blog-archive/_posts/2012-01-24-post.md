*Cloud**Kahua* Kahuaのメモリリークの調査と対策

*[Sumibi.org*]を「さくらのクラウド」に引越した後もKahuaのメモリリーク問題が解決していなかった。
急遽RAM容量の大きなサーバインスタンスに変更して運用回避していたが、このまま無意味なコストの垂れ流しを止めるべく調査した。
やっと解決したので調査結果を書いておこうと思う。
このまま放置するとコスト削減額はなんと月額4000円にもなるので、ちょいと見過ごすわけにはいかないのである。

## 概要
*[Sumibi.org*]のサイトは1台のサーバインスタンスで構成されており、*[Sumibi.org*]の日本語変換サービスと、Wikiシステムの*[OldType*]が同居している。
メモリリーク問題は*[OldType*]のほうにあり、使っているKahuaフレームワークのworkerのプロセスが膨張していくというのが問題だった。
Kahuaのworkerがメモリを圧迫し、結果的に*[Sumibi.org*]の変換レスポンスが重くなるという現象が発生していた。

## 膨張のペース
*[OldType*]を1日程度放置すると、Kahuaのworkerプロセスが1個につき1.2GByteまで膨張する。
常時2個のworkerを起動する設定にしていたため、3GByteのRAMでは足りず、swapを2G Byteほど侵食し、*[OldType*]のサイトがエラーを返すようになる。
GoogleやYahooのクローラが来て、サイトのページを一巡するとworkerは1.2GByteあたりになる。なぜか1.2GByte以上には膨張しないようだ。

## 回避策
 *[http://cloud.sakura.ad.jp/payment/simulation.php|さくらのクラウドの料金シミュレーション*] ページより
 ##(img http://pix.am/HhG0.png)
原因究明までの間、「さくらのクラウド」のインスタンスを3GByteから6GByteにして20日間ほど回避した。
6GByteならリークしていても問題なく運用できていた。ランニングコストを除いては問題ない(笑)
しかし、お金さえ払えば、問題を先送りして普通に運用できるのはクラウドサービスの良いところである。

## 対策
workerを1時間に1回リスタートするスクリプトを動かして対応した。
このスクリプトはOT_SITEにサイトバンドルのパスさえ設定すれば、どんなKahuaアプリでも使えるはず。
 *[http://gist.github.com/1669942|hourly restarter for Kahua workers(restarter.sh)*]

## 結果
RAM 3GByteでも約1GByteの余裕を持って運用できるようになった。

青い線はリザルトコード。一番下側に張りついている線は、"200 OK"のリクエスト。
"404 Not Found"が大量に出るのは、Kahuaフレームワークが非ブラウザが動的生成されたURLを叩いた時だ、自動的に404にしてくれているようだ。頼もしい。
 ##(img http://pix.am/GCG6.png)

restarter.shをリスタートすると、freeメモリのグラフがキザギザになる。うまくいっているようだ。
restarter.shを一定期間止めておいて、再度開始する実験をしたが、freeエリアがいっきに復活している。うまくいっているようだ。
 ##(img http://pix.am/kWkz.png)

## まとめ
*[OldType*]もしくはKahuaのworkerプロセスが膨張するが、workerプロセスの定期的restartをかければ問題なく運用できる。
なぜworkerがそんなにメモリを消費するのかという原因追求はしていない。
対処療法的ではあるが対策し、無用なランニングコストを抑えることができた。

##(comment-data shiro worker%e3%83%97%e3%83%ad%e3%82%bb%e3%82%b9%e3%81%af%e7%b6%99%e7%b6%9a%e3%82%92%e3%81%9f%e3%81%8f%e3%81%95%e3%82%93%e3%83%8f%e3%83%83%e3%82%b7%e3%83%a5%e3%83%86%e3%83%bc%e3%83%96%e3%83%ab%e3%81%ab%e7%99%bb%e9%8c%b2%e3%81%97%e3%81%a6%e3%81%be%e3%81%99%e3%81%8c%e3%80%81%e3%81%9d%e3%82%8c%e3%81%aeexpire%e3%81%8c%e3%81%86%e3%81%be%e3%81%8f%e3%81%84%e3%81%a3%e3%81%a6%e3%81%aa%e3%81%84%e3%81%ae%e3%81%8b%e3%81%aa%3f%0d%0aworker%e3%81%8c%e6%8e%b4%e3%82%93%e3%81%a7%e3%82%8b%e7%b6%99%e7%b6%9a%e3%81%ae%e4%b8%80%e8%a6%a7%e3%82%92%e3%83%a2%e3%83%8b%e3%82%bf%e3%81%a7%e3%81%8d%e3%82%8b%e3%82%88%e3%81%86%e3%81%ab%e3%81%97%e3%81%a6%e3%81%bf%e3%82%8b%e3%81%a8%e3%81%84%e3%81%84%e3%81%8b%e3%82%82%e3%80%82%e3%81%a1%e3%82%87%e3%81%a3%e3%81%a8%e8%a6%8b%e3%81%a6%e3%81%bf%e3%81%be%e3%81%99%e3%80%82)
##(comment-data kiyoka %e9%80%9a%e5%b8%b8%e9%81%8b%e7%94%a8%e3%81%a7%e3%80%81worker%e3%81%8c%e8%86%a8%e5%bc%b5%e3%81%99%e3%82%8b%e3%81%ae%e3%81%a7shiro%e3%81%95%e3%82%93%e3%81%ae%e4%ba%88%e6%83%b3%e3%81%af%e5%bd%93%e3%81%9f%e3%81%a3%e3%81%a6%e3%81%84%e3%82%8b%e3%81%8b%e3%82%82%e3%81%97%e3%82%8c%e3%81%be%e3%81%9b%e3%82%93%e3%80%82%0d%0aOldType%e3%81%af%e3%82%b3%e3%83%b3%e3%83%86%e3%83%b3%e3%83%84%e3%83%9a%e3%83%bc%e3%82%b8%e3%81%ae%ef%bc%91%e8%a1%8c%e6%af%8e%e3%81%ab%e7%b6%99%e7%b6%9a%e3%81%8c%e7%94%9f%e6%88%90%e3%81%95%e3%82%8c%e3%81%a6%e3%81%84%e3%82%8b%e3%81%ae%e3%81%a7%e3%80%81%e9%96%8b%e6%94%be%e3%81%95%e3%82%8c%e3%81%aa%e3%81%84%e3%81%a8%e3%81%99%e3%82%8b%e3%81%a8%e3%81%99%e3%81%90%e3%81%abworker%e3%81%8c%e8%82%a5%e5%a4%a7%e3%81%97%e3%81%9d%e3%81%86%e3%81%a7%e3%81%99%e3%81%ad%e3%80%82%0d%0a%e4%bb%a5%e5%89%8dshiro%e3%81%95%e3%82%93%e3%82%82chaton%e3%81%a7%e5%90%8c%e6%a7%98%e3%81%ae%e7%8f%be%e8%b1%a1%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%e3%80%81%e4%bb%96%e3%81%ab%e5%90%8c%e3%81%98%e3%82%88%e3%81%86%e3%81%aa%e7%8f%be%e8%b1%a1%e3%82%92%e8%a6%8b%e3%81%9f%e4%ba%ba%e3%81%af%e3%81%84%e3%81%be%e3%81%9b%e3%82%93%e3%81%8b%e3%81%a8%e3%81%84%e3%81%86%e3%82%88%e3%81%86%e3%81%aa%e6%9b%b8%e3%81%8d%e8%be%bc%e3%81%bf%e3%82%92%e3%81%95%e3%82%8c%e3%81%a6%e3%81%84%e3%81%9f%e3%81%a8%e6%80%9d%e3%81%84%e3%81%be%e3%81%99%e3%81%8c%e3%80%81%e3%81%be%e3%81%95%e3%81%ab%e3%81%93%e3%82%8c%e3%81%8c%e3%81%9d%e3%81%86%e3%81%8b%e3%82%82%e3%80%82%0d%0a%e5%90%8c%e3%81%98%e5%8e%9f%e5%9b%a0%e3%81%a0%e3%81%a8%e3%81%84%e3%81%84%e3%81%a7%e3%81%99%e3%81%ad%e3%80%82%e3%82%88%e3%82%8d%e3%81%97%e3%81%8f%e3%81%8a%e9%a1%98%e3%81%84%e3%81%97%e3%81%be%e3%81%99%e3%80%82)
